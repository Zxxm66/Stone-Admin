{% extends "base.html" %}

{% block title %}–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - Stone Shop Admin{% endblock %}

{% block header_title %}–°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π{% endblock %}

{% block content %}
<div class="content-section">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å—Å—ã–ª–æ–∫ -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-value">{{ total_users }}</div>
            <div class="stat-label">–í–°–ï–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô</div>
            <div class="stat-description">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ –±–æ—Ç–µ</div>
        </div>
        <div class="stat-card" style="background: var(--profit-bg);">
            <div class="stat-value" id="onlineUsers">{{ online_users }}</div>
            <div class="stat-label">–û–ù–õ–ê–ô–ù –°–ï–ô–ß–ê–°</div>
            <div class="stat-description">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        </div>
    </div>

<!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div class="notification-form-card">
    <h3>üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h3>

    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div class="notification-type-selector" style="margin-bottom: 20px;">
        <button type="button" class="btn-type active" data-type="general">üé± –û–±—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
        <button type="button" class="btn-type" data-type="discount">üî• –¢–æ–≤–∞—Ä—ã —Å–æ —Å–∫–∏–¥–∫–æ–π</button>
    </div>

    <form id="notificationForm">
        <!-- –û–±—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="generalNotification" class="notification-type-content">
            <div class="form-group">
                <label for="notificationType">–¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</label>
                <select id="notificationType" class="form-control">
                    <option value="general">üé± –û–±—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</option>
                    <option value="sale">üìâ –°–∫–∏–¥–∫–∏ –∏ –∞–∫—Ü–∏–∏</option>
                    <option value="new_arrivals">üÜï –ù–æ–≤—ã–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</option>
                    <option value="important">‚ÄºÔ∏èÔ∏è –í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</option>
                    <option value="technical">‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã</option>
                </select>
            </div>

            <div class="form-group">
                <label for="notificationMessage">–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</label>
                <textarea id="notificationMessage" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è..." rows="5" maxlength="4000"></textarea>
                <div class="char-counter">
                    <span id="charCount">0</span>/4000 —Å–∏–º–≤–æ–ª–æ–≤
                </div>
            </div>

            <div class="form-group">
                <label for="notificationImages">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–æ 9 —Ñ–æ—Ç–æ):</label>
                <input type="file" id="notificationImages" class="form-control" accept="image/jpeg,image/png,image/gif" multiple>
                <small style="color: #666; font-size: 12px;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞: 5MB. –§–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF. –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –¥–æ 9 —Ñ–æ—Ç–æ.</small>
                <div id="imageWarning" style="display: none; color: #ff9800; font-size: 12px; margin-top: 5px;">
                    ‚ö†Ô∏è PNG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JPG.
                </div>
                <div id="selectedImages" class="selected-images" style="margin-top: 10px;"></div>
            </div>

            <!-- –ë–ª–æ–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å" -->
            <div class="form-group" id="productButtonSection" style="display: none;">
                <label>
                    <input type="checkbox" id="addProductButton"> –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ö—É–ø–∏—Ç—å" –∫ —Ç–æ–≤–∞—Ä—É
                </label>

                <div id="productButtonFields" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <div class="form-group">
                        <label for="productName">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:</label>
                        <input type="text" id="productName" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
                    </div>
                    <div class="form-group">
                        <label for="productPrice">–¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ (—Ä—É–±–ª–∏):</label>
                        <input type="number" id="productPrice" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –≤ —Ä—É–±–ª—è—Ö" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="productId">ID —Ç–æ–≤–∞—Ä–∞ :</label>
                        <input type="text" id="productId" class="form-control" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ–≤–∞—Ä–∞">

                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:</label>
                <div id="notificationPreview" class="preview-box">
                    –¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...
                </div>
            </div>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–∫–∏–¥–∫–∞—Ö -->
        <div id="discountNotification" class="notification-type-content" style="display: none;">
            <div class="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã —Å–æ —Å–∫–∏–¥–∫–æ–π –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:</label>
                <div id="discountProductsList" class="products-list">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–∏–¥–∫–∞–º–∏...</div>
                </div>
                <div class="form-help">
                    –ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ —Å —Ñ–æ—Ç–æ, –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏ –∫–Ω–æ–ø–∫–æ–π "–ö—É–ø–∏—Ç—å"
                </div>
            </div>

            <div class="selected-products-stats">
                <strong>–í—ã–±—Ä–∞–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: <span id="selectedProductsCount">0</span></strong>
            </div>
        </div>

        <!-- –ö–ù–û–ü–ö–ò –û–¢–ü–†–ê–í–ö–ò -->
        <div class="form-actions">
            <!-- –î–ª—è –æ–±—â–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
            <div id="generalSendButtons">
                <button type="button" id="sendBtn" class="btn btn-primary">
                    üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º ({{ total_users }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
                </button>
                <button type="button" id="sendWithoutImagesBtn" class="btn btn-secondary" style="margin-left: 10px;">
                    üì® –ë–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                </button>
            </div>

            <!-- –î–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å–∫–∏–¥–∫–∞—Ö -->
            <div id="discountSendButtons" style="display: none;">
                <button type="button" id="sendDiscountsBtn" class="btn btn-primary">
                    üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã ({{ total_users }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
                </button>
                <button type="button" id="selectAllDiscountsBtn" class="btn btn-secondary" style="margin-left: 10px;">
                    ‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                </button>
                <button type="button" id="deselectAllDiscountsBtn" class="btn btn-secondary" style="margin-left: 10px;">
                    ‚ùå –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä
                </button>
            </div>
        </div>
    </form>
</div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫ -->
    <div class="history-card">
        <h3>üìã –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫</h3>

        <div id="notificationHistory" class="history-list">
            {% for notification in notifications %}
            <div class="history-item" data-id="{{ notification.id }}">
                <div class="history-header">
                    <span class="notification-type {{ notification.type }}">
                        {% if notification.type == 'sale' %}üìâ –ê–∫—Ü–∏—è
                        {% elif notification.type == 'new_arrivals' %}üÜï –ù–æ–≤—ã–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
                        {% elif notification.type == 'important' %}‚ÄºÔ∏è –í–∞–∂–Ω–æ–µ
                        {% elif notification.type == 'technical' %}üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã
                        {% else %}üé± –û–±—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ{% endif %}
                    </span>
                    <span class="notification-date">{{ notification.created_at }}</span>
                </div>
                <div class="notification-text">{{ notification.message }}</div>
                {% if notification.image_url %}
                <div class="notification-image">
                    <img src="{{ notification.image_url }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" style="max-width: 200px; border-radius: 5px;">
                </div>
                {% endif %}
                <div class="notification-stats">
                    <span class="stat-success">‚úÖ {{ notification.success_count }}</span>
                    <span class="stat-failed">‚ùå {{ notification.fail_count }}</span>
                    <span class="stat-total">üë• {{ notification.total_count }}</span>
                </div>
            </div>
            {% else %}
            <div class="no-history">
                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Å—ã–ª–∫–∞—Ö</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Notifications page loaded');
    initializeNotifications();
    initializeProductSelection();
});

function initializeNotifications() {
    const messageTextarea = document.getElementById('notificationMessage');
    const charCount = document.getElementById('charCount');
    const sendBtn = document.getElementById('sendBtn');
    const sendWithoutImagesBtn = document.getElementById('sendWithoutImagesBtn');
    const imagesInput = document.getElementById('notificationImages');
    const addProductButtonCheckbox = document.getElementById('addProductButton');
    const productButtonSection = document.getElementById('productButtonSection');
    const productButtonFields = document.getElementById('productButtonFields');

    // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
    if (messageTextarea && charCount) {
        messageTextarea.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = length;

            if (length > 4000) {
                charCount.style.color = '#dc3545';
                sendBtn.disabled = true;
                sendWithoutImagesBtn.disabled = true;
            } else {
                charCount.style.color = '#28a745';
                sendBtn.disabled = false;
                sendWithoutImagesBtn.disabled = false;
            }

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            updatePreview();
        });
        charCount.textContent = messageTextarea.value.length;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    if (imagesInput) {
        imagesInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const selectedImagesContainer = document.getElementById('selectedImages');
            const warning = document.getElementById('imageWarning');

            selectedImagesContainer.innerHTML = '';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
            if (files.length > 9) {
                showError('–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ –±–æ–ª–µ–µ 9 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π');
                this.value = '';
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å" –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            if (files.length === 1) {
                productButtonSection.style.display = 'block';
            } else {
                productButtonSection.style.display = 'none';
                addProductButtonCheckbox.checked = false;
                productButtonFields.style.display = 'none';
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤
            let hasPng = false;
            files.forEach((file, index) => {
                if (file.type === 'image/png') {
                    hasPng = true;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
                const imgPreview = document.createElement('div');
                imgPreview.className = 'image-preview';
                imgPreview.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <span style="margin-right: 10px;">${index + 1}. ${file.name}</span>
                        <button type="button" class="btn-remove-image" data-index="${index}" style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 12px;">‚úï</button>
                    </div>
                `;
                selectedImagesContainer.appendChild(imgPreview);
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è PNG
            warning.style.display = hasPng ? 'block' : 'none';

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
            document.querySelectorAll('.btn-remove-image').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    removeImage(index);
                });
            });
        });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–±–æ–∫—Å–∞ "–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –ö—É–ø–∏—Ç—å"
    if (addProductButtonCheckbox) {
        addProductButtonCheckbox.addEventListener('change', function() {
            productButtonFields.style.display = this.checked ? 'block' : 'none';
        });
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞
    document.getElementById('notificationType').addEventListener('change', updatePreview);

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
    if (sendBtn) {
        sendBtn.addEventListener('click', function() {
            const message = messageTextarea.value.trim();
            if (!message) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                return;
            }

            const imageFiles = document.getElementById('notificationImages').files;
            const addProductButton = document.getElementById('addProductButton').checked;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å –ø–æ–ª–µ–π —Ç–æ–≤–∞—Ä–∞
            if (addProductButton) {
                const productName = document.getElementById('productName').value.trim();
                const productPrice = document.getElementById('productPrice').value.trim();

                if (!productName) {
                    showError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞');
                    return;
                }
                if (!productPrice || parseFloat(productPrice) <= 0) {
                    showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞');
                    return;
                }
            }

            if (imageFiles.length === 0 && addProductButton) {
                showError('–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å" –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                return;
            }

            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ${imageFiles.length > 0 ? `—Å ${imageFiles.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏` : '–±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π'} –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?`)) {
                sendNotification(true);
            }
        });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    if (sendWithoutImagesBtn) {
        sendWithoutImagesBtn.addEventListener('click', function() {
            const message = messageTextarea.value.trim();
            if (!message) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
                return;
            }

            if (confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?`)) {
                sendNotification(false);
            }
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞
function removeImage(index) {
    const input = document.getElementById('notificationImages');
    const files = Array.from(input.files);

    // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –ø–æ –∏–Ω–¥–µ–∫—Å—É
    files.splice(index, 1);

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π FileList (—á–µ—Ä–µ–∑ DataTransfer)
    const dt = new DataTransfer();
    files.forEach(file => dt.items.add(file));
    input.files = dt.files;

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å"
    const productButtonSection = document.getElementById('productButtonSection');
    if (files.length === 1) {
        productButtonSection.style.display = 'block';
    } else {
        productButtonSection.style.display = 'none';
        document.getElementById('addProductButton').checked = false;
        document.getElementById('productButtonFields').style.display = 'none';
    }

    // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ change –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
    input.dispatchEvent(new Event('change'));
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
async function sendNotification(withImages = true) {
    const message = document.getElementById('notificationMessage').value.trim();
    const type = document.getElementById('notificationType').value;
    const sendBtn = document.getElementById('sendBtn');
    const sendWithoutImagesBtn = document.getElementById('sendWithoutImagesBtn');
    const addProductButton = document.getElementById('addProductButton').checked;
    const productName = document.getElementById('productName').value.trim();
    const productPrice = document.getElementById('productPrice').value;
    const productId = document.getElementById('productId').value.trim();

    if (!message) return;

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
    sendBtn.disabled = true;
    sendWithoutImagesBtn.disabled = true;

    if (withImages) {
        sendBtn.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏...';
    } else {
        sendWithoutImagesBtn.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
    }

    try {
        let response;

        if (withImages) {
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ FormData
            const formData = new FormData();
            formData.append('message', message);
            formData.append('type', type);

            const imageFiles = document.getElementById('notificationImages').files;
            if (imageFiles.length === 0) {
                throw new Error('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω—ã');
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            if (imageFiles.length > 9) {
                throw new Error('–ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ 9 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π');
            }

            for (let i = 0; i < imageFiles.length; i++) {
                const file = imageFiles[i];
                if (file.size > 5 * 1024 * 1024) {
                    throw new Error(`–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è "${file.name}" –ø—Ä–µ–≤—ã—à–∞–µ—Ç 5MB`);
                }
                formData.append('images', file);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (addProductButton && imageFiles.length === 1) {
                formData.append('add_product_button', 'true');
                formData.append('product_name', productName);
                formData.append('product_price', productPrice);
                if (productId) {
                    formData.append('product_id', productId);
                }
            }

            console.log(`üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å ${imageFiles.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏...`);
            response = await fetch('/api/send-notification', {
                method: 'POST',
                body: formData
            });
        } else {
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ JSON
            console.log('üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...');
            const requestData = {
                message: message,
                type: type
            };

            response = await fetch('/api/send-notification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });
        }

        console.log('üì® –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç, —Å—Ç–∞—Ç—É—Å:', response.status, response.statusText);

        const responseText = await response.text();
        console.log('üìÑ –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', responseText);

        if (!responseText || responseText.trim() === '') {
            throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
        }

        let result;
        try {
            result = JSON.parse(responseText);
            console.log('‚úÖ JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω:', result);
        } catch (parseError) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', parseError);
            throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON: ' + parseError.message);
        }

        if (result.success) {
            const successMessage = withImages ?
                `‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å ${result.image_count || 0} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${result.sent_count || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É'} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!` :
                `‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${result.sent_count || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É'} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!`;

            showSuccess(successMessage);

            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('notificationForm').reset();
            document.getElementById('charCount').textContent = '0';
            document.getElementById('imageWarning').style.display = 'none';
            document.getElementById('selectedImages').innerHTML = '';
            document.getElementById('productButtonSection').style.display = 'none';
            document.getElementById('productButtonFields').style.display = 'none';
            updatePreview();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }

    } catch (error) {
        console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        showError('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
    } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
        sendBtn.disabled = false;
        sendWithoutImagesBtn.disabled = false;
        sendBtn.innerHTML = `üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º ({{ total_users }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)`;
        sendWithoutImagesBtn.innerHTML = `üì® –ë–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`;
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
function updatePreview() {
    const message = document.getElementById('notificationMessage').value.trim();
    const previewBox = document.getElementById('notificationPreview');

    if (!message) {
        previewBox.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞';
        previewBox.style.color = '#666';
        return;
    }

    const prefixes = {
        'sale': ' <b></b>\n\n',
        'new_arrivals': ' <b></b>\n\n',
        'important': ' <b></b>\n\n',
        'technical': ' <b>–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –†–ê–ë–û–¢–´</b>\n\n',
        'general': ' <b></b>\n\n'
    };

    const typeSelect = document.getElementById('notificationType');
    const prefix = prefixes[typeSelect ? typeSelect.value : 'general'] || ' <b>–£–í–ï–î–û–ú–õ–ï–ù–ò–ï</b>\n\n';
    previewBox.innerHTML = prefix + message.replace(/\n/g, '<br>');
    previewBox.style.color = '#333';
}

function showError(message) {
    if (typeof showNotification === 'function') {
        showNotification(message, 'error');
    } else {
        alert('‚ùå ' + message);
    }
}

function showSuccess(message) {
    if (typeof showNotification === 'function') {
        showNotification(message, 'success');
    } else {
        alert('‚úÖ ' + message);
    }
}

// ========== –ö–û–î –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –û –°–ö–ò–î–ö–ê–• ==========

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
document.querySelectorAll('.btn-type').forEach(btn => {
    btn.addEventListener('click', function() {
        const type = this.getAttribute('data-type');

        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        document.querySelectorAll('.btn-type').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ–æ—Ä–º—É
        document.querySelectorAll('.notification-type-content').forEach(content => {
            content.style.display = 'none';
        });

        document.getElementById('generalSendButtons').style.display = 'none';
        document.getElementById('discountSendButtons').style.display = 'none';

        if (type === 'general') {
            document.getElementById('generalNotification').style.display = 'block';
            document.getElementById('generalSendButtons').style.display = 'block';
        } else if (type === 'discount') {
            document.getElementById('discountNotification').style.display = 'block';
            document.getElementById('discountSendButtons').style.display = 'block';
            loadDiscountedProducts();
        }
    });
});

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–∏–¥–∫–∞–º–∏
async function loadDiscountedProducts() {
    const container = document.getElementById('discountProductsList');
    container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–∏–¥–∫–∞–º–∏...</div>';

    try {
        const response = await fetch('/api/discounted-products');
        const result = await response.json();

        if (result.success) {
            displayDiscountedProducts(result.products);
        } else {
            container.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${result.error}</div>`;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
        container.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</div>`;
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–∏–¥–∫–∞–º–∏
function displayDiscountedProducts(products) {
    const container = document.getElementById('discountProductsList');

    if (!products || products.length === 0) {
        container.innerHTML = '<div class="no-products">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–∏–¥–∫–æ–π</div>';
        return;
    }

    let html = '<div class="discount-products-grid">';

    products.forEach(product => {
        const oldPrice = product.price;
        const newPrice = product.discount_price;
        const discount = product.discount_percent;
        const economy = oldPrice - newPrice;

        html += `
<div class="discount-product-card" data-product-id="${product.id}" onclick="toggleProductSelection('${product.id}')">
    <div class="product-checkbox-wrapper">
        <input type="checkbox" class="product-select" value="${product.id}" id="product_${product.id}">
        <label for="product_${product.id}" class="product-checkbox-label" onclick="event.stopPropagation()">
            <span class="checkmark"></span>
        </label>
    </div>

    <div class="product-content">
        <div class="product-image">
            ${product.has_image ?
                `<img src="${product.main_image}" alt="${product.name}" onerror="this.style.display='none'">` :
                '<div class="no-image">üì∑</div>'
            }
        </div>

        <div class="product-info">
            <div class="product-name">${product.name}</div>
            <div class="product-brand">${product.brand || '–ë–µ–∑ –±—Ä–µ–Ω–¥–∞'}</div>

            <div class="product-sku">–ê—Ä—Ç–∏–∫—É–ª: ${product.sku}</div>

            <div class='product-size'>–†–∞–∑–º–µ—Ä: ${product.size_name}</div>

            <div class='product-quantity'>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${product.quantity}</div>

            <div class="product-prices">
                <span class="old-price">${oldPrice}‚ÇΩ</span>
                <span class="new-price">${newPrice}‚ÇΩ</span>
            </div>

            <div class="discount-info">
                <span class="discount-percent">-${discount}%</span>
                <span class="economy">–≠–∫–æ–Ω–æ–º–∏—è ${economy}‚ÇΩ</span>
            </div>
        </div>
    </div>
</div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
    updateSelectedCount();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É
function toggleProductSelection(productId) {
    const checkbox = document.querySelector(`#product_${productId}`);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;

        // –î–æ–±–∞–≤–ª—è–µ–º/—É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å selected –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
        const card = checkbox.closest('.discount-product-card');
        if (checkbox.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
        updateSelectedCount();
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤
function initializeProductSelection() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('product-select')) {
            const card = e.target.closest('.discount-product-card');
            if (e.target.checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
            updateSelectedCount();
        }
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
function updateSelectedCount() {
    const selected = document.querySelectorAll('.product-select:checked');
    document.getElementById('selectedProductsCount').textContent = selected.length;
}

// –í—ã–±—Ä–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
document.getElementById('selectAllDiscountsBtn').addEventListener('click', function() {
    document.querySelectorAll('.product-select').forEach(checkbox => {
        checkbox.checked = true;
        const card = checkbox.closest('.discount-product-card');
        card.classList.add('selected');
    });
    updateSelectedCount();
});

// –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä
document.getElementById('deselectAllDiscountsBtn').addEventListener('click', function() {
    document.querySelectorAll('.product-select').forEach(checkbox => {
        checkbox.checked = false;
        const card = checkbox.closest('.discount-product-card');
        card.classList.remove('selected');
    });
    updateSelectedCount();
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å–∫–∏–¥–∫–∞—Ö
document.getElementById('sendDiscountsBtn').addEventListener('click', async function() {
    const selectedProducts = Array.from(document.querySelectorAll('.product-select:checked'))
        .map(checkbox => checkbox.value);

    if (selectedProducts.length === 0) {
        showError('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏');
        return;
    }

    const btn = this;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
    btn.disabled = true;

    if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å ${selectedProducts.length} —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–∏–¥–∫–æ–π –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?`)) {
        btn.innerHTML = originalText;
        btn.disabled = false;
        return;
    }

    try {
        const response = await fetch('/api/send-discounts-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                product_ids: selectedProducts
            })
        });

        const result = await response.json();

        if (result.success) {
            showSuccess(`‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–∫–∏–¥–∫–∞—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã! –£—Å–ø–µ—à–Ω–æ: ${result.sent_count}, –û—à–∏–±–æ–∫: ${result.fail_count}`);

            // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä
            document.querySelectorAll('.product-select:checked').forEach(checkbox => {
                checkbox.checked = false;
                const card = checkbox.closest('.discount-product-card');
                card.classList.remove('selected');
            });
            updateSelectedCount();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showError('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + result.error);
        }

    } catch (error) {
        showError('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∞
async function updateOnlineUsers() {
    try {
        const response = await fetch('/api/user-stats');
        const data = await response.json();

        if (data.success && data.online_users !== undefined) {
            document.getElementById('onlineUsers').textContent = data.online_users;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∞:', error);
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(updateOnlineUsers, 30000);

// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
updateOnlineUsers();
</script>

<style>
#notificationImages {
    width: 100%;
    padding: 10px;
    border: 2px dashed #cbd5e0;
    border-radius: 8px;
    background: #f8fafc;
    cursor: pointer;
    transition: all 0.3s ease;
}

#notificationImages:hover {
    border-color: #007bff;
    background: #f0f7ff;
}

#notificationImages::file-selector-button {
    background: linear-gradient(135deg, #3750a1 0%, #131c39 100%);
    color: white;
    border: none;
    padding: 10px 10px;
    border-radius: 6px;
    margin-right: 10px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
}

#notificationImages::file-selector-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

/* –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
.stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(15px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: var(--card-bg);
    border-radius: 10px;
    padding: 20px;
    color: white;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.notification-form-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.history-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.form-group {
    margin-bottom: 15px;
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.char-counter {
    text-align: right;
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

.preview-box {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 5px;
    padding: 15px;
    min-height: 60px;
    font-size: 14px;
    line-height: 1.4;
}

.form-actions {
    margin-top: 20px;
    text-align: center;
}

.btn {
    padding: 12px 12px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 5px;
}

.btn-primary {
    background: var(--primary-color);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    color: #131c39;
}

.btn-secondary {
    background: #6c757d;
    color: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
}

.btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

.history-item {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: #f8f9fa;
}

.history-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-weight: 600;
}

.notification-stats {
    display: flex;
    gap: 15px;
    margin-top: 10px;
    font-size: 14px;
}

.stat-success { color: #28a745; }
.stat-failed { color: #dc3545; }
.stat-total { color: #6c757d; }

.notification-image {
    margin: 10px 0;
}

.notification-image img {
    max-width: 200px;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#imageWarning {
    padding: 8px;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 4px;
    margin-top: 5px;
}

.selected-images {
    border: 1px solid #e9ecef;
    border-radius: 5px;
    padding: 10px;
    background: #f8f9fa;
}

.image-preview {
    padding: 5px;
    border-bottom: 1px solid #dee2e6;
}

.image-preview:last-child {
    border-bottom: none;
}

.btn-remove-image {
    cursor: pointer;
    font-size: 12px;
    padding: 2px 6px;
}

#productButtonFields {
    border: 1px solid #dee2e6;
    border-radius: 5px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
.notification-type-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.btn-type {
    flex: 1;
    padding: 12px;
    border: 2px solid #e9ecef;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-type:hover {
    border-color: var(--primary-color);
}

.btn-type.active {
    border-color: var(--primary-color);
    background: var(--primary-color);
    color: #131c39;
}

/* –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –°–ü–ò–°–ö–ê –¢–û–í–ê–†–û–í –°–û –°–ö–ò–î–ö–ê–ú–ò */
.discount-products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    background: #f8f9fa;
}

.discount-product-card {
    position: relative;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0;
    transition: all 0.3s ease;
    cursor: pointer;
    overflow: hidden;
}

.discount-product-card:hover {
    border-color: var(--primary-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.discount-product-card.selected {
    border-color: var(--primary-color);
    background: #f0f7ff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.product-checkbox-wrapper {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
}

/* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —á–µ–∫–±–æ–∫—Å */
.product-checkbox-wrapper input[type="checkbox"] {
    display: none;
}

.product-checkbox-label {
    display: block;
    width: 24px;
    height: 24px;
    background: white;
    border: 2px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
}

.product-checkbox-label:hover {
    border-color: var(--primary-color);
}

.product-checkbox-wrapper input[type="checkbox"]:checked + .product-checkbox-label {
    background: var(--primary-color);
    border-color: var(--primary-color);
}

.product-checkbox-wrapper input[type="checkbox"]:checked + .product-checkbox-label::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.product-content {
    padding: 15px;
    display: flex;
    gap: 12px;
}

.product-image {
    width: 60px;
    height: 60px;
    flex-shrink: 0;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
}

.product-image .no-image {
    width: 100%;
    height: 100%;
    background: #e9ecef;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.product-info {
    flex: 1;
    min-width: 0;
}

.product-name {
    font-weight: 600;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.product-brand {
    color: #666;
    font-size: 12px;
    margin-bottom: 8px;
}

.product-sku {
    color: #666;
    font-size: 11px;
}

.product-size {
    color: #666;
    font-size: 12px;
    margin-bottom: 8px;
}

.product-quantity {
    color: #666;
    font-size: 11px;
}

.product-prices {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.old-price {
    text-decoration: line-through;
    color: #999;
    font-size: 14px;
}

.new-price {
    color: #dc3545;
    font-weight: 600;
    font-size: 16px;
}

.discount-info {
    display: flex;
    gap: 8px;
    margin-bottom: 4px;
}

.discount-percent {
    background: #dc3545;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
}

.economy {
    color: #28a745;
    font-size: 14px;
    font-weight: 500;
}

.selected-products-stats {
    background: #e7f3ff;
    padding: 10px;
    border-radius: 6px;
    margin: 10px 0;
    text-align: center;
}

.loading, .no-products, .error {
    text-align: center;
    padding: 20px;
    color: #666;
}

.error {
    color: #dc3545;
}

.form-help {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
    .discount-products-grid {
        grid-template-columns: 1fr;
        gap: 10px;
    }

    .discount-product-card {
        padding: 0;
    }

    .product-content {
        padding: 12px;
    }

    .product-image {
        width: 50px;
        height: 50px;
    }

    .product-checkbox-label {
        width: 20px;
        height: 20px;
    }

    .product-checkbox-wrapper input[type="checkbox"]:checked + .product-checkbox-label::after {
        font-size: 12px;
    }
}
</style>
{% endblock %}