{% extends "base.html" %}

{% block title %}Возвраты - Stone Shop Admin{% endblock %}

{% block content %}
<div class="dashboard-header fade-in">
    <h1><i class="fas fa-undo icon"></i>Управление возвратами</h1>
    <p>Обработка запросов на возврат товаров</p>
</div>

<div class="table-container fade-in">
    {% if error %}
    <div class="error-message">
        <p>{{ error }}</p>
    </div>
    {% endif %}
    
    {% if returns %}
    <table>
        <thead>
            <tr>
                <th>ID возврата</th>
                <th>Заказ</th>
                <th>Клиент</th>
                <th>Товар</th>
                <th>Количество</th>
                <th>Причина</th>
                <th>Статус</th>
                <th>Дата запроса</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for return in returns %}
            <tr>
                <td>#{{ return.id }}</td>
                <td>#{{ return.order_id }}</td>
                <td>{{ return.user_name }}</td>
                <td>{{ return.product_name }} ({{ return.size_value }})</td>
                <td>{{ return.quantity }} шт.</td>
                <td>{{ return.reason or 'Не указана' }}</td>
                <td>
                    <span class="status-badge status-{{ return.status }}">
                        {{ return.status_ru }}
                    </span>
                </td>
                <td>{{ return.created_at }}</td>
                <td>
                    {% if return.status == 'pending' %}
                    <button onclick="processReturn({{ return.id }}, 'approved')" class="btn btn-success">
                        <i class="fas fa-check icon"></i>Одобрить
                    </button>
                    <button onclick="processReturn({{ return.id }}, 'rejected')" class="btn btn-danger">
                        <i class="fas fa-times icon"></i>Отклонить
                    </button>
                    {% else %}
                    <span>Обработан: {{ return.processed_at }}</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="padding: 2rem; text-align: center;">
        <p>Возвратов нет</p>
    </div>
    {% endif %}
</div>

<script>
async function processReturn(returnId, action) {
    if (!confirm(`Вы уверены, что хотите ${action === 'approved' ? 'одобрить' : 'отклонить'} этот возврат?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/returns/${returnId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action: action })
        });
        
        if (response.ok) {
            alert(`Возврат ${action === 'approved' ? 'одобрен' : 'отклонен'} успешно`);
            location.reload();
        } else {
            alert('Ошибка при обработке возврата');
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка при обработке возврата');
    }
}
</script>
{% endblock %}